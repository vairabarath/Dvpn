# Protocol Buffers Compilation Guide

This document explains how to compile the Protocol Buffer (protobuf) files in the DVPN project.

## Overview

The DVPN project uses gRPC services defined in `.proto` files. These files need to be compiled into Go code to be used by the application.

## Directory Structure

```
Dvpn/
├── clientPeer/
│   ├── proto/          # Source .proto files
│   │   ├── base_node.proto
│   │   ├── exit_peer.proto
│   │   └── super_node.proto
│   ├── pb/             # Generated Go files
│   └── compile_proto.sh
├── super/
│   ├── proto/          # Source .proto files
│   │   ├── base_node.proto
│   │   ├── exit_peer.proto
│   │   └── super_node.proto
│   ├── pb/             # Generated Go files
│   └── compile_proto.sh
└── compile_all_proto.sh
```

## Prerequisites

Make sure you have the following tools installed:

1. **Protocol Compiler (protoc)**
   ```bash
   # Check if installed
   protoc --version
   ```

2. **Go Protocol Buffers plugin**
   ```bash
   go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
   ```

3. **Go gRPC plugin**
   ```bash
   go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
   ```

## Compilation Methods

### Method 1: Compile All (Recommended)

Use the master script to compile proto files for both directories:

```bash
cd Dvpn
./compile_all_proto.sh
```

This script will:
- Compile proto files for both `clientPeer` and `super` directories
- Test that both modules build successfully
- Display a summary of generated files

### Method 2: Compile Individual Directories

#### For clientPeer:
```bash
cd Dvpn/clientPeer
./compile_proto.sh
```

#### For super:
```bash
cd Dvpn/super
./compile_proto.sh
```

### Method 3: Manual Compilation

If you prefer manual control:

```bash
# For clientPeer
cd Dvpn
protoc --proto_path=clientPeer/proto \
       --go_out=clientPeer/pb \
       --go-grpc_out=clientPeer/pb \
       clientPeer/proto/*.proto

# For super
protoc --proto_path=super/proto \
       --go_out=super/pb \
       --go-grpc_out=super/pb \
       super/proto/*.proto
```

## Generated Files

Each compilation generates 6 files per directory:

### clientPeer/pb/:
- `base_node.pb.go` - Base node message definitions
- `base_node_grpc.pb.go` - Base node gRPC service definitions  
- `exit_peer.pb.go` - Exit peer message definitions
- `exit_peer_grpc.pb.go` - Exit peer gRPC service definitions
- `super_node.pb.go` - Super node message definitions
- `super_node_grpc.pb.go` - Super node gRPC service definitions

### super/pb/:
- Same files as above, but with `go_package = "./pb"` configuration

## Protocol Buffer Services

### BaseNodeService
- `RegisterSuperNode` - Register a super node with the base node
- `SuperNodeHeartbeat` - Send heartbeat from super node
- `GetActiveSuperNodes` - Get list of active super nodes
- `RequestExitRegion` - Request super nodes in specific region

### ExitPeerService  
- `GetWireGuardInfo` - Get WireGuard configuration from exit peer

### SuperNodeService
- `RegisterClientPeer` - Register a client peer
- `PeerSessionHeartbeat` - Send session heartbeat
- `RequestExitPeer` - Request an exit peer
- `RequestExit` - Request exit node configuration

## Key Differences

The main difference between `clientPeer` and `super` proto configurations:

- **clientPeer**: `go_package = "Client_peer/pb"`
- **super**: `go_package = "./pb"`

This ensures proper package paths for each module's imports.

## Troubleshooting

### Common Issues

1. **"protoc: command not found"**
   - Install Protocol Compiler: `sudo apt install protobuf-compiler`

2. **"protoc-gen-go: program not found"**
   - Install Go plugin: `go install google.golang.org/protobuf/cmd/protoc-gen-go@latest`
   - Ensure `$GOPATH/bin` is in your `$PATH`

3. **"protoc-gen-go-grpc: program not found"**
   - Install gRPC plugin: `go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest`

4. **Build failures after compilation**
   - Run `go mod tidy` in the affected directory
   - Check import paths in your Go files

### Verification

After compilation, verify everything works:

```bash
# Test clientPeer build
cd Dvpn/clientPeer && go build

# Test super build  
cd Dvpn/super && go build
```

## Best Practices

1. **Always recompile** after modifying `.proto` files
2. **Use the master script** (`./compile_all_proto.sh`) for consistency
3. **Commit both** `.proto` files and generated `.pb.go` files to version control
4. **Test builds** after compilation to catch issues early

## Notes

- Generated files contain a header comment: `// Code generated by protoc-gen-go. DO NOT EDIT.`
- Never manually edit generated `.pb.go` files
- The compilation scripts handle nested directory cleanup automatically
- All scripts include error handling and will exit on failure